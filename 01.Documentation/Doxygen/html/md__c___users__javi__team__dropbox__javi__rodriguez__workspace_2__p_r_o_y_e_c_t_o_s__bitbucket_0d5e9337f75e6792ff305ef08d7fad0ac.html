<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Battery doc: Logging Tech Note</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Battery doc
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__c___users__javi__team__dropbox__javi__rodriguez__workspace_2__p_r_o_y_e_c_t_o_s__bitbucket_0d5e9337f75e6792ff305ef08d7fad0ac.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Logging Tech Note </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Inicializacion del valor de los elementos de diagnostico. Lectura y comprobacion de las memorias EEPROM, tanto la del chasis como la de la bateria. Cada elemento posee el valor, el nombre y la categoria:</p>
<h1><a class="anchor" id="autotoc_md71"></a>
Arquitectura de la memoria del SAMD21G18</h1>
<p >La memoria de un MCU SAM D21 está mapeada en cuatro secciones:</p>
<ul>
<li>Memoria Flash</li>
<li>Memoria Flash con capacidad de lectura y escritura (RWW)</li>
<li>RAM interna</li>
<li>Periféricos y puertos de E/S</li>
</ul>
<p >&lt;img src=".Images/arq-samd21.jpg" alt=""IMAGE NOT FOUND""/&gt;</p>
<p >En nuestro caso usaremos el MCU SAMD21G18. Por lo tento tendremos una memoria de 256Kbytes.</p>
<p >La memoria de programa esta dividad en colummnas (<em>rows</em>) y paginas (<em>pages</em>). Cada columna contiene 4 paginas.</p>
<p >El tamaño de estas paginas estan predefinidas a 64 bytes, a un tamaño de 32 bits (4 bytes) por palabra, tenemos que en cada pagina hay 16 variables.</p>
<p >&lt;img src=".Images/page.form.jpg" alt=""IMAGE NOT FOUND""/&gt;</p>
<p >DEbido a este formato reducimos las variables utiles a 15.</p>
<p >Deebido a la falta de una seccion de memoria no volatil para el ussuaria, es posible configurar una zona de emulacion de memoria EEPROM al final del stack de la memoria flash.</p>
<p >Este espacio puede ser de los siguientes tamaños:</p>
<p >&lt;img src=".Images/eepromsizes.jpg" alt=""IMAGE NOT FOUND""/&gt;</p>
<p >En nuestro caso haremos uso de una memoeria emualda de 256 bytes. Lo que se traduce en 1 columna de 4 paginas, un total de 4 x 64 bytes = 256 bytes /4 bytes per word - 1 word per header per word = 60 variables.</p>
<p >Estas variables se alm,acenara en la parte no volatil de la memoria. Sin embargo esta memoria tiene una vida util limitada, por lo que es necesario que se controle muy bien el momento de la escritura.</p>
<h2><a class="anchor" id="autotoc_md72"></a>
Memoria Externa I2C</h2>
<p >El acceso a la memoria externa situada en la bateria, se realiza por I2C utilizando la tecnica de BitBang debido a la comparticion de los canales de I2C con el puerto USB y el pulsador. Por esta razon es aconsajable separar la comunicacion de los puertos por defecto.</p>
<h1><a class="anchor" id="autotoc_md73"></a>
Funciones Privadas</h1>
<ul>
<li><b>Init_diagnostic_elements</b>()</li>
<li>* Serial Port (X o S). Con X no se muestra con S si. </li>
</ul>
<h1><a class="anchor" id="autotoc_md74"></a>
* Guardado en EEPROM (X,B,C). X no se guarda, B se guarda en la Bateria y C se guarda en el Chasis.</h1>
<ul>
<li><b>LogDiagnosticData</b> ( &lt;integer&gt; , &lt;integer&gt;)<ul>
<li>Actualizar el valor en Ram de una variable de adiagnostico</li>
<li><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">data</td><td>Valor del dato. </td></tr>
  </table>
  </dd>
</dl>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md75"></a>
* @param address Direccion en la memoria RAM de la variable.</h1>
<ul>
<li><b>ReadDiagnoticData(Address)</b><ul>
<li>: Lectura del valor de un elem,ento de diagnostico.</li>
<li><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname"></td><td>Address. Direccion de almacenamiento en el array de elementos en RAM. </td></tr>
  </table>
  </dd>
</dl>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md76"></a>
* @return:  valor del elemento de diagnostico.</h1>
<ul>
<li><b>IncrementDiagnosticdata</b> (&lt;integer&gt;,&lt;integer&gt;)<ul>
<li>: Incremente en una cantidad el valor de un dato de diagnostico. </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md77"></a>
* @param: Incremento, address.</h1>
<ul>
<li><b>PrintDiagnosticData</b> (&lt;integer&gt;)<ul>
<li>: Muestrea por el puerto serie o guarda en EEPROM los datos de diagnostico. </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md78"></a>
* @param: type_print.</h1>
<ul>
<li><b>PrintStaticData</b> </li>
</ul>
<h1><a class="anchor" id="autotoc_md79"></a>
* @brief: Impresion por el puerto serie de los datos estaticos.</h1>
<ul>
<li><b>isValid</b>()<ul>
<li>: Devuelve un boleano indicando si la memoria eemprom contiene datos o esta vacia.</li>
<li><dl class="section return"><dt>Returns</dt><dd>: bool<ul>
<li>True: La memoria contiene valores. </li>
</ul>
</dd></dl>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md80"></a>
* False: La memoria esta vacia.</h1>
<ul>
<li><b>Stats</b>(int,int)<ul>
<li>: Incremento de las estadisticas del valor de voltaje y potencia usado. Se incremeneta en 1 el valor de la posicion de un array correspondiente. Ej: 12.3 v -&gt; voltages_values[ 123 ] ++</li>
<li><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname"></td><td>volts </td></tr>
  </table>
  </dd>
</dl>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md81"></a>
* @param: wats</h1>
<ul>
<li><b>UpdateEeepromBatery</b>(): </li>
</ul>
<h1><a class="anchor" id="autotoc_md82"></a>
* @brief:  Actualizacion de la memoria EEPROM de la Bateria. Antes de relaizar el guardado se comprueba que el valor a guardar sea distinto del valor ya almacenado.</h1>
<ul>
<li><b>PrintStats</b>(): </li>
</ul>
<h1><a class="anchor" id="autotoc_md83"></a>
* @brief: Muestreo por el puerto serie de los valores acumulados de las estadisticas de potencia y voltage.Ademas de algunos datos estaticos guardados en eeprom como el numero de serio o el modelo.</h1>
<ul>
<li><b>ResetBateriaEeprom</b>():<ul>
<li>: Puesta a 0 de las primeras 1024 posiciones de la EEPROM de la Bateria.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md84"></a>
TESTs</h1>
<h2><a class="anchor" id="autotoc_md85"></a>
TEST_0</h2>
<p >Testeo de las funciones de LogDiagnosticData, PrintHeader and PrintDiagnosticData (Serial Port).</p>
<h2><a class="anchor" id="autotoc_md86"></a>
TEST_1</h2>
<p >Testeo de la funcionalidad de guardado en EEMPROM. Prueba de las funciones <a class="el" href="diagnostic_8h.html#afe93e17ac89cd97917811068ba2af214" title="Devuelve true si la memoeria RAM contiene datos y false si la memeoria RAM esta vacia.">isValid()</a>, Incremeent DiagnosticData.</p>
<h2><a class="anchor" id="autotoc_md87"></a>
TEST_2</h2>
<p >Test del guardado y lectura de la eeprom chasis. Para ello se utiliza y prueba la funcion de estadisticas.</p>
<h2><a class="anchor" id="autotoc_md88"></a>
TEST_3</h2>
<p >Test que permite medir la velocidad de escritura de 1, 10 y 20 bytes, a traves de la libreria de BitBang I2c. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
